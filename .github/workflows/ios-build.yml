name: Build iOS IPA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      # 1. 设置 Flutter 环境
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.4'
          channel: 'stable'
          cache: true

      # 2. 深度修复依赖冲突 (解决 path 和 flutter_lints 版本过高问题)
      - name: Force Compatible Dependencies
        run: |
          # 修复之前遇到的 path 冲突
          sed -i '' 's/path: \^1.9.1/path: 1.9.0/g' pubspec.yaml
          
          # 修复这次遇到的 flutter_lints 冲突 (降级到与 Dart 3.5.4 兼容的 4.0.0 版本)
          sed -i '' 's/flutter_lints: \^6.0.0/flutter_lints: ^4.0.0/g' pubspec.yaml
          
          echo "Dependencies downgraded for compatibility with Flutter 3.24.4"

      # 3. 安装 Dart 依赖
      - name: Install Dart Dependencies
        run: |
          flutter pub get
          # 生成数据库和国际化代码
          flutter pub run build_runner build --delete-conflicting-outputs
          dart run intl_utils:generate

      # 4. 安装 iOS 原生依赖 (CocoaPods)
      - name: Install CocoaPods
        run: |
          cd ios
          # 使用 --repo-update 确保 FFmpeg 等插件能被正确拉取
          pod install --repo-update
          cd ..

      # 5. 构建 iOS 工程 (不签名)
      - name: Build iOS (No Codesign)
        run: |
          flutter build ios --release --no-codesign

      # 6. 封装为 IPA
      - name: Create IPA (Payload trick)
        run: |
          mkdir -p Payload
          if [ -d "build/ios/iphoneos/Runner.app" ]; then
            cp -r build/ios/iphoneos/Runner.app Payload/
            zip -r FluxTube-Unsigned.ipa Payload
          else
            echo "Error: Runner.app not found."
            exit 1
          fi
          
      # 7. 上传产物
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FluxTube-iOS-Unsigned
          path: FluxTube-Unsigned.ipa
          retention-days: 7
